#!/usr/bin/env bash

set -euo pipefail

# Docker needs to be started from the project root
# to mount the volumes
pushd "$PWD"

# Get the env
declare -a DOCKER_ENV_ARGS=()
DIRENV_EXPORTED_ENVS=${DIRENV_EXPORTED_ENVS:-}
if [ "$DIRENV_EXPORTED_ENVS" != "" ]; then
  IFS=',' read -ra DIRENV_EXPORTED_KEYS_AS_ARRAY <<< "$DIRENV_EXPORTED_ENVS"
  for ENV in "${DIRENV_EXPORTED_KEYS_AS_ARRAY[@]}"; do
      # Filter out all docker variable
      if [[ $ENV == DOCKER* ]]; then
          continue
      fi
      if [[ -v $ENV ]]; then
          DOCKER_ENV_ARGS+=("-e")
          DOCKER_ENV_ARGS+=("$ENV=${!ENV}")
      fi
  done
fi

# Set the ports
declare -a DOCKER_PORTS_ARGS=()
DOCKER_PORTS=${DOCKER_PORTS:-}
if [ "$DOCKER_PORTS" != "" ]; then
  IFS=',' read -ra DOCKER_PORTS_AS_ARRAY <<< "$DOCKER_PORTS"
  for DOCKER_PORT_MAPPING in "${DOCKER_PORTS_AS_ARRAY[@]}"; do
      if [[ -v $DOCKER_PORT_MAPPING ]]; then
          DOCKER_PORTS_ARGS+=("-p")
          DOCKER_PORTS_ARGS+=("$DOCKER_PORT_MAPPING")
      fi
  done
fi

# Set the groups
declare -a DOCKER_USER_GROUPS_ARGS=()
DOCKER_USER_GROUPS=${DOCKER_USER_GROUPS:-}
if [ "$DOCKER_USER_GROUPS" != "" ]; then
  IFS=',' read -ra DOCKER_USER_GROUPS_AS_ARRAY <<< "$DOCKER_USER_GROUPS"
  for DOCKER_GROUP in "${DOCKER_USER_GROUPS_AS_ARRAY[@]}"; do
      if [[ -v $DOCKER_GROUP ]]; then
          DOCKER_USER_GROUPS_ARGS+=("--group-add")
          DOCKER_USER_GROUPS_ARGS+=("$DOCKER_GROUP")
      fi
  done
fi

# The user
declare -a DOCKER_USER_ARG=()
DOCKER_USER=${DOCKER_USER:-}
if [ "$DOCKER_PORTS" != "" ]; then
  DOCKER_USER_ARG+=("--user")
  DOCKER_USER_ARG+=("$DOCKER_USER")
fi


declare -a DOCKER_OPTIONS=()
declare -a DOCKER_COMMAND_ARGS=()
# Parsing
for arg in "$@"; do
  case "$arg" in
  -*)
    if [ ${#DOCKER_COMMAND_ARGS[@]} -eq 0 ]; then
      echo "Options ($arg) found"
      DOCKER_OPTIONS+=("$arg")
    else
      # An option for the command
      echo "Command/Arg ($arg) found"
      DOCKER_COMMAND_ARGS+=("$arg")
    fi
    ;;
  *)
    echo "Command/Arg ($arg) found"
    DOCKER_COMMAND_ARGS+=("$arg")
    ;;
  esac
done


# Start the container
docker run \
  --name "${DOCKER_CONTAINER:-dockenv}" \
  "${DOCKER_USER_ARG[@]}" \
  "${DOCKER_USER_GROUPS_ARGS[@]}"  \
  --rm \
  "${DOCKER_PORTS_ARGS[@]}" \
  "${DOCKER_ENV_ARGS[@]}" \
  "${DOCKER_OPTIONS[@]}" \
  "${DOCKER_REGISTRY:-docker.io}"/"${DOCKER_NAMESPACE}"/"${DOCKER_NAME}":"$DOCKER_TAG" \
  "${DOCKER_COMMAND_ARGS[@]}"

popd
